<div class="tx-issue-tooltip-loading" style="display: none; position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 12px; width: 500px; z-index: 15000; font-size: 12px;">
  <div class="issue-loading" style="font-weight: bold; color: #333; margin-bottom: 4px;">
    <span class="issue-loading-text" style="color: #666; font-size: 11px;">ì´ìŠˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</span>
  </div>
</div>

<div class="tx-issue-tooltip" style="display: none; position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 12px; width: 500px; z-index: 15000; font-size: 12px;">
  <!-- ì´ìŠˆ í—¤ë” -->
  <div class="issue-header" style="border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 4px; position: relative; padding-right: 95px;">
    <a class="issue-schedule-summary-link icon icon-stats"
       href="#"
       target="_blank"
       style="position: absolute; top: 0; right: 0; display: none;">
      <svg class="s18 icon-svg" aria-hidden="true"><use href="<%= asset_path('icons.svg') %>#icon--stats"></use></svg>
      <span class="icon-label" style="font-size: 11px; color: #169;">ì¼ì •ìš”ì•½</span>
    </a>
    <div class="issue-title" style="font-weight: bold; color: #333; margin-bottom: 4px;">
      <span class="issue-tracker tracker" style="color: #666; font-size: 11px;"></span>
      <span class="issue-id id" style="color: #169; font-weight: bold;"></span>:
      <span class="issue-subject subject" style="color: #333;"></span>
    </div>
  </div>

  <!-- ìƒíƒœ ë° ìš°ì„ ìˆœìœ„ -->
  <div class="issue-status-section" style="margin-bottom: 4px;">
    <table style="width: 100%; font-size: 11px;">
      <tr>
        <td><span style="color: #666; padding: 2px 4px;">ìƒíƒœ:</span>
        <span class="issue-status status" style="font-weight: bold;"></span></td>
        <td><span style="color: #666; padding: 2px 4px;">ìš°ì„ ìˆœìœ„:</span>
        <span class="issue-priority priority"></span></td>
        <td><span style="color: #666; padding: 2px 4px;">ë²”ì£¼:</span>
        <span class="issue-category category"></span></td>
      </tr>
    </table>
  </div>

  <!-- ë‹´ë‹¹ì ë° ì¹´í…Œê³ ë¦¬ -->
  <div class="issue-assignment-section" style="margin-bottom: 4px;">
    <table style="width: 100%; font-size: 11px;">
      <tr>
        <td><span style="color: #666; padding: 2px 4px;">ìƒì„±ì:</span>
        <span class="issue-author author"></span></td>
        <td><span style="color: #666; padding: 2px 4px;">ë‹´ë‹¹ì:</span>
        <span class="issue-assigned-to assigned_to"></span></td>
      </tr>
      <tr>
        <td><span style="color: #666; padding: 2px 4px;">ë²„ì „:</span>
        <span class="issue-fixed-version fixed_version"></span></td>
        <td><span style="color: #666; padding: 2px 4px;">ì§„í–‰ë¥ :</span>
        <div class="progress-bar" style="width: 60px; height: 14px; background: #f0f0f0; border: 1px solid #ddd; display: inline-block; margin-left: 8px; position: relative;vertical-align: middle;">
          <div class="progress-fill" style="height: 100%; background: #759fcf; width: 0%;"></div>
          <span class="issue-done-ratio done_ratio" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold; color: #000;">0%</span>
        </div>
        </td>
      </tr>
      <tr>
        <td><span style="color: #666; padding: 2px 4px;">ì‹œì‘ì¼:</span>
        <span class="issue-start-date start_date">-</span></td>
        <td><span style="color: #666; padding: 2px 4px;">ë§ˆê°ì¼:</span>
        <span class="issue-due-date due_date">-</span></td>
      </tr>
    </table>
  </div>

  <!-- ì¼ì • ë° ì§„í–‰ë¥  -->
  <!-- ì‘ì—… ì‹œê°„ -->
  <div class="issue-work-time-section" style="margin-bottom: 4px; font-size: 11px;">
    <table style="width: 100%;">
      <tr>
        <td colspan="2"><span style="color: #666; padding: 2px 4px;">ì¶”ì •ì‹œê°„:</span>
        <span class="issue-estimated-hours estimated_hours">ì—†ìŒ</span></td>
      </tr>
      <tr>
        <td><span style="color: #666; padding: 2px 4px;">ì‘ì—…ì:</span>
        <span class="issue-worker worker"></span></td>
        <td><span style="color: #666; padding: 2px 4px;">ì‘ì—…ì‹œê°„:</span>
        <span class="issue-work-period work_period">-</span></td>
      </tr>
    </table>
  </div>
  
  <!-- ì„¤ëª… -->
  <div class="issue-description-section" style="margin-bottom: 4px; font-size: 11px; border-top: 1px solid #eee;">
    <table style="width: 100%;">
      <tr>
        <td colspan="2"><span style="color: #666; padding: 2px 4px;">ì„¤ëª…:</span>
        <span class="issue-description description"></span></td>
      </tr>
    </table>
  </div>

  <!-- ì²¨ë¶€ íŒŒì¼ë“¤ -->
  <div class="issue-attachments-section" style="border-top: 1px solid #eee; padding-top: 4px;">
    <div class="attachments-header" style="font-weight: bold; color: #666; margin-bottom: 4px; font-size: 11px;">
      ì²¨ë¶€ íŒŒì¼ë“¤ (<span class="attachments-count">0</span>)
    </div>
    <div class="issue-attachments attachments">
      <!-- ì²¨ë¶€ íŒŒì¼ë“¤ì´ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- í•˜ìœ„ ì´ìŠˆë“¤ -->
  <div class="issue-children-section" style="border-top: 1px solid #eee; padding-top: 4px;">
    <div class="children-header" style="font-weight: bold; color: #666; margin-bottom: 4px; font-size: 11px;">
      í•˜ìœ„ ì´ìŠˆë“¤ (<span class="children-count">0</span>)
    </div>
    <div class="issue-childrens childrens" style="max-height: 120px; overflow-y: auto;">
      <!-- í•˜ìœ„ ì´ìŠˆë“¤ì´ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- ë‚ ì§œ ì •ë³´ -->
  <div class="issue-dates-section" style="margin-bottom: 2px; font-size: 10px; color: #999; border-top: 1px solid #eee; padding-top: 2px;">
    <table style="width: 100%; cell-padding: 0px; cell-spacing: 0px;">
      <tr>
        <td align="left"><span style="color: #666; padding: 0px 0px;">ìƒì„±ì:</span>
        <span class="issue-author author"></span></td>
        <td align="right"><span style="color: #666; padding: 0px 0px;">ìƒì„±ì¼:</span>
        <span class="issue-created-on created_on"></span></td>
        <td align="right"><span style="color: #666; padding: 0px 0px;">ìˆ˜ì •ì¼:</span>
        <span class="issue-updated-on updated_on"></span></td>
      </tr>
    </table>
  </div>

</div>

<!-- í•˜ìœ„ ì´ìŠˆ í…œí”Œë¦¿ (JavaScriptì—ì„œ ë³µì œí•˜ì—¬ ì‚¬ìš©) -->
<template id="child-issue-template">
  <div class="child-issue" style="border-left: 3px solid #ddd; padding: 4px 6px; margin: 2px 0; background: #f9f9f9; font-size: 10px;">
    <div class="child-header" style="margin-bottom: 2px;">
      <span class="child-id" style="color: #169; font-weight: bold;"></span>:
      <span class="child-subject" style="color: #333;"></span>
      <span class="child-status" style="font-weight: bold;"></span>
      - <span class="child-done-ratio">0%</span>
      <div class="child-progress-bar" style="width: 40px; height: 6px; background: #f0f0f0; border: 1px solid #ddd; display: inline-block; margin-left: 4px; position: relative;">
        <div class="child-progress-fill" style="height: 100%; background: #759fcf; width: 0%;"></div>
      </div>
    </div>
  </div>
</template>

<style>
.issue-tooltip {
  font-family: Verdana, sans-serif;
}
.issue-tooltip table {
  border-collapse: collapse;
}
.issue-tooltip td {
  vertical-align: top;
}
.progress-bar {
  border-radius: 3px;
}
.progress-fill {
  border-radius: 2px;
}
.child-progress-bar {
  border-radius: 2px;
}
.child-progress-fill {
  border-radius: 1px;
}
.issue-childrens::-webkit-scrollbar {
  width: 6px;
}
.issue-childrens::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}
.issue-childrens::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}
.issue-childrens::-webkit-scrollbar-thumb:hover {
  background: #bbb;
}
</style>


<script>

    var tooltip = $('.tx-issue-tooltip');
    var tooltipTimer = null;
    var hideTimer = null;
    var cachedIssueData = {}; // ì´ìŠˆ ë°ì´í„° ìºì‹œ  
  
  
    // ë§ˆìš°ìŠ¤ í˜¸ë²„ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function showTooltip(e, issueId) {
        // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
        clearTimeout(hideTimer);
        clearTimeout(tooltipTimer);
        
        tooltipTimer = setTimeout(function() {

            // íˆ´íŒ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (í™”ë©´ ë°–ì—ì„œ ì„ì‹œë¡œ í‘œì‹œí•˜ì—¬ ë†’ì´ ê³„ì‚°)
            tooltip.css({
                'display': 'block',
                'visibility': 'hidden',
                'left': e.pageX + 10 + 'px',
                'top': e.pageY + 10 + 'px'
            });
            
            // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if (cachedIssueData[issueId]) {
                applyIssueDataToTooltip(cachedIssueData[issueId]);
                // ìœ„ì¹˜ ì¬ì¡°ì •
                adjustTooltipPosition(e);
            } else {
                // AJAXë¡œ ì´ìŠˆ ë””í…Œì¼ ìš”ì²­
                var projectIdentifier = '<%= @project ? @project.identifier : "" %>';
                var url = '/issue_detail/' + issueId;
                
                $.ajax({
                url: url,
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    // ìºì‹œì— ì €ì¥
                    cachedIssueData[issueId] = data;
                    // íˆ´íŒì— ì ìš©
                    applyIssueDataToTooltip(data);
                    // ìœ„ì¹˜ ì¬ì¡°ì •
                    adjustTooltipPosition(e);
                },
                error: function() {
                    console.error('Failed to load issue detail for issue #' + issueId);
                    tooltip.css('display', 'none');
                }
                });
            }
        }, 500); // 0.5ì´ˆ ë”œë ˆì´
    }

    // íˆ´íŒ ìì²´ì— ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ ë‹«íˆì§€ ì•Šë„ë¡
    tooltip.on('mouseenter', function() {
        clearTimeout(hideTimer);
    }).on('mouseleave', function() {
        hideTooltip();
    });

    // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        return date.getFullYear() + '-' + 
            String(date.getMonth() + 1).padStart(2, '0') + '-' + 
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0');
    }
    
    function formatDate(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        return date.getFullYear() + '-' + 
            String(date.getMonth() + 1).padStart(2, '0') + '-' + 
            String(date.getDate()).padStart(2, '0');
    }

    // ì‹œê°„ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
    function calculateHoursDifference(beginTime, endTime) {
        if (!beginTime || !endTime) return null;
        
        var begin = new Date(beginTime);
        var end = new Date(endTime);
        var diffMs = end.getTime() - begin.getTime();
        var diffMinutes = Math.round(diffMs / (1000 * 60)); // ë¶„ ë‹¨ìœ„ë¡œ ê³„ì‚°
        
        if (diffMinutes >= 1440) { // 24ì‹œê°„(1440ë¶„) ì´ìƒ
            // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ì‹œì‘ì¼ë¶€í„° ì¢…ë£Œì¼ê¹Œì§€ í¬í•¨)
            var beginDate = new Date(begin.getFullYear(), begin.getMonth(), begin.getDate());
            var endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());
            var diffDays = Math.round((endDate.getTime() - beginDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;
            return diffDays + 'ì¼';
        } else if (diffMinutes >= 60) { // 1ì‹œê°„(60ë¶„) ì´ìƒ
            var diffHours = Math.floor(diffMinutes / 60);
            return diffHours + 'ì‹œê°„';
        } else { // 1ì‹œê°„ ë¯¸ë§Œ
            return diffMinutes + 'ë¶„';
        }
    }

    // ì‘ì—… ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
    function formatWorkPeriod(beginTime, endTime) {
        if (!beginTime && !endTime) return '-';
        
        var beginText = beginTime ? formatDate(beginTime) : '';
        var endText = endTime ? formatDate(endTime) : '';
        
        if (beginTime && endTime) {
            var hoursDiff = calculateHoursDifference(beginTime, endTime);
            return beginText + ' ~ ' + endText + ' (' + hoursDiff + ')';
        } else {
            return beginText + ' ~ ' + endText;
        }
    }

    function formatEstimatedHours(hours) {
        if (hours === null) return '-';
        if (hours === 0) return 'ì¦‰ì‹œ';
        if (hours >= 8 ) return Math.round(hours/8.0) + 'ì¼';
        return Math.round(hours) + 'ì‹œê°„';
    }

    // íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë°˜í™˜ í•¨ìˆ˜
    function getFileIcon(contentType) {
        if (!contentType) contentType = '';
        contentType = contentType.toLowerCase();
        
        var iconStyle = 'margin-right: 4px; font-size: 12px;';
        
        if (contentType.includes('image/')) {
            return '<span style="' + iconStyle + ' color: #4CAF50;">ğŸ–¼ï¸</span>';
        } else if (contentType.includes('pdf')) {
            return '<span style="' + iconStyle + ' color: #F44336;">ğŸ“„</span>';
        } else if (contentType.includes('msword') || contentType.includes('wordprocessingml')) {
            return '<span style="' + iconStyle + ' color: #2196F3;">ğŸ“</span>';
        } else if (contentType.includes('excel') || contentType.includes('spreadsheetml')) {
            return '<span style="' + iconStyle + ' color: #4CAF50;">ğŸ“Š</span>';
        } else if (contentType.includes('powerpoint') || contentType.includes('presentationml')) {
            return '<span style="' + iconStyle + ' color: #FF9800;">ğŸ“ˆ</span>';
        } else if (contentType.includes('zip') || contentType.includes('rar') || contentType.includes('tar') || contentType.includes('compressed')) {
            return '<span style="' + iconStyle + ' color: #9C27B0;">ğŸ—œï¸</span>';
        } else if (contentType.includes('video/')) {
            return '<span style="' + iconStyle + ' color: #E91E63;">ğŸ¬</span>';
        } else if (contentType.includes('audio/')) {
            return '<span style="' + iconStyle + ' color: #FF5722;">ğŸµ</span>';
        } else if (contentType.includes('text/')) {
            return '<span style="' + iconStyle + ' color: #607D8B;">ğŸ“</span>';
        } else if (contentType.includes('json') || contentType.includes('xml')) {
            return '<span style="' + iconStyle + ' color: #795548;">âš™ï¸</span>';
        } else {
            return '<span style="' + iconStyle + ' color: #9E9E9E;">ğŸ“</span>';
        }
    }

    // ì´ìŠˆ ë°ì´í„°ë¥¼ íˆ´íŒì— ì ìš©í•˜ëŠ” í•¨ìˆ˜
    function applyIssueDataToTooltip(data) {
        if (!data.success || !data.issue) return;

        var issue = data.issue;
        //var tooltip = $('.tx-issue-tooltip');

        //tooltip_loading.css('display', 'none');
        tooltip.css('display', 'block');

        // description ì²˜ë¦¬: HTML íƒœê·¸ ì œê±°
        var description = issue.description || '';
        if( description.length > 0 ) {

          // HTML íƒœê·¸ ì œê±°
          // description = description.replace(/<[^>]*>?/g, '');
          // description ì—ì„œ http ë‚˜ https ë§í¬ê°€ ìˆì„ê²½ìš° <a href="URL">ë§í¬</a> ë¡œ ë³€í™˜
          // description = description.replace(/https?:\/\/[^\s]+/g, function(url) { return '<a href="' + url + '" target="_blank">ë§í¬</a>'; });

          // description ì— !aaa.png! ì™€ ê°™ì€ íŒŒì¼ ë§í¬ê°€ ìˆì„ê²½ìš° issue.attachments ì—ì„œ ì°¾ì•„ì„œ <img src="URL" /> ë¡œ ë³€í™˜
          description = description.replace(/!([^!]+)!/g, function(match, filename) {
            var decodedFilename = decodeURIComponent(filename);
            var attachment = issue.attachments.find(function(attachment) {
              var decodedAttachmentName = decodeURIComponent(attachment.filename);
              return decodedAttachmentName === decodedFilename;
            });
            if (attachment) {
              //alert( '<img src=' + attachment.url + '" />' );
              return '<img class="filecontent image" src="' + attachment.url + '" width="100%" />';
            }
            return match; // ì²¨ë¶€íŒŒì¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì›ë³¸ í…ìŠ¤íŠ¸ ìœ ì§€
          });

          // description ì— {{video(aaaaa.mp4)}} ì™€ ê°™ì€ íŒŒì¼ ë§í¬ê°€ ìˆì„ê²½ìš° issue.attachments ì—ì„œ ì°¾ì•„ì„œ <embed src="URL" /> ë¡œ ë³€í™˜
          description = description.replace(/\{\{video\((.+?)\)\}\}/g, function(match, filename) {
            var attachment = issue.attachments.find(function(attachment) {
              return attachment.filename === filename;
            });
            if (attachment) {
              return '<video autoplay loop controls style="width: 100%; height: auto;"><source src="' + attachment.url + '" width="100%" /></video>';
            }
            return match; // ì²¨ë¶€íŒŒì¼ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì›ë³¸ í…ìŠ¤íŠ¸ ìœ ì§€
          });

          var lines = description.split(/\r?\n/);
          // ë¹ˆ ì¤„ ì œê±°
          lines = lines.filter(function(line) {
              return line.trim().length > 0;
          });

          /*
          // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„í• í•˜ì—¬ ìµœëŒ€ 7ì¤„ë§Œ ì„ íƒ
          if (lines.length > 7) {
              lines = lines.slice(0, 7);
              lines.push('...'); // ë” ë§ì€ ë‚´ìš©ì´ ìˆìŒì„ í‘œì‹œ
          } 
          */       
          // HTMLìš© ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜
          description = lines.join('<br>');
          tooltip.find('.issue-description-section').css('display', 'block');
        }
        else
        {
          tooltip.find('.issue-description-section').css('display', 'none');
        }

        // ê¸°ë³¸ ì •ë³´ ì ìš©
        tooltip.find('.issue-tracker').text(issue.tracker || '');
        tooltip.find('.issue-id').html('<a href="/issues/' + issue.id + '" target="_blank">#' + issue.id + '</a>');
        tooltip.find('.issue-subject').text(issue.subject || '');
        tooltip.find('.issue-project').text(issue.project || '');
        tooltip.find('.issue-description').html(description || '');
        tooltip.find('.issue-status').text(issue.status || '');
        tooltip.find('.issue-priority').text(issue.priority || '');
        tooltip.find('.issue-assigned-to').text(issue.assigned_to || '-');
        tooltip.find('.issue-author').text(issue.author || '-');
        tooltip.find('.issue-worker').text(issue.worker || '-');
        tooltip.find('.issue-category').text(issue.category || '-');
        tooltip.find('.issue-fixed-version').html(issue.fixed_version || '-');
        tooltip.find('.issue-start-date').text(formatDate(issue.start_date));
        tooltip.find('.issue-due-date').text(formatDate(issue.due_date));
        tooltip.find('.issue-done-ratio').text(( issue.done_ratio || 0 ) + '%');
        tooltip.find('.issue-spent-hours').text(issue.spent_hours || 0);
        tooltip.find('.issue-work-period').text(formatWorkPeriod(issue.begin_time, issue.end_time));
        tooltip.find('.issue-created-on').text(formatDateTime(issue.created_on));
        tooltip.find('.issue-updated-on').text(formatDateTime(issue.updated_on));
        tooltip.find('.issue-estimated-hours').text(formatEstimatedHours(issue.estimated_hours));

        // ì¼ì •ìš”ì•½ ë§í¬ (ìµœìƒìœ„ ë¶€ëª¨ ê¸°ì¤€)
        // Redmineì˜ /projects/:id ëŠ” ë³´í†µ numeric idê°€ ì•„ë‹ˆë¼ identifierë¥¼ ì‚¬ìš©
        var projectKey = issue.project_identifier || issue.project_id;
        var topParentId = issue.top_parent_id || issue.id;
        var summaryLink = tooltip.find('.issue-schedule-summary-link');
        if (projectKey && topParentId) {
          var summaryUrl = '/projects/' + encodeURIComponent(projectKey) + '/milestone/schedule_summary?issue_ids=' + encodeURIComponent(topParentId);
          summaryLink.attr('href', summaryUrl).show();
        } else {
          summaryLink.hide();
        }

        // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
        tooltip.find('.progress-fill').css('width', (issue.done_ratio || 0) + '%');
        
        // í•˜ìœ„ ì´ìŠˆë“¤ ì²˜ë¦¬
        var childrenContainer = tooltip.find('.issue-childrens');
        childrenContainer.empty();
        
        if (issue.childrens && issue.childrens.length > 0) {
          tooltip.find('.children-count').text(issue.childrens.length);
          
          issue.childrens.forEach(function(child) {
              var childHtml = '<div class="child-issue" style="border-left: 3px solid #ddd; padding: 4px 6px; margin: 2px 0px 0px ' + (child.depth * 10) + 'px; background: #f9f9f9; font-size: 10px;">' +
              '<div class="child-header" style="margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center;">' +
              '<div>' +
              '<a href="/issues/' + child.id + '" target="_blank"><span class="child-id" style="color: #169; font-weight: bold;">#' + child.id + '</span></a>: ' +
              '<span class="child-subject" style="color: #333;">' + (child.subject || '') + '</span>' +
              '</div>' +
              '<div style="display: flex; align-items: center; gap: 4px;">' +
              '<span class="child-status" style="font-weight: bold;">' + (child.status || '') + '</span> ' +
              '- <span class="child-done-ratio">' + (child.done_ratio || 0) + '%</span> ' +
              '<div class="child-progress-bar" style="width: 40px; height: 6px; background: #f0f0f0; border: 1px solid #ddd; display: inline-block; margin-left: 4px; position: relative;">' +
              '<div class="child-progress-fill" style="height: 100%; background: #759fcf; width: ' + (child.done_ratio || 0) + '%;"></div>' +
              '</div>' +
              '</div>' +
              '</div>' +
              '</div>';
              childrenContainer.append(childHtml);
          });
          tooltip.find('.issue-children-section').css('display', 'block');
        } else {
          tooltip.find('.children-count').text('0');
          tooltip.find('.issue-children-section').css('display', 'none');
        }

        // ì²¨ë¶€íŒŒì¼ ì²˜ë¦¬
        var attachments = issue.attachments || [];
        if( attachments.length > 0 ) {
          tooltip.find('.attachments-count').text(attachments.length);
          var attachmentsContainer = tooltip.find('.issue-attachments');
          attachmentsContainer.empty();
          attachments.forEach(function(attachment) {
            var fileIcon = getFileIcon(attachment.content_type);
            var attachmentHtml = '<div class="attachment-item">' + fileIcon + '<a href="' + attachment.url + '" target="_blank">' + attachment.filename + '</a></div>';
            attachmentsContainer.append(attachmentHtml);
          });
          tooltip.find('.issue-attachments-section').css('display', 'block');
        }
        else {
          tooltip.find('.issue-attachments-section').css('display', 'none');
        }
    }

    function hideTooltip() {
        clearTimeout(tooltipTimer);
        clearTimeout(hideTimer);
        
        hideTimer = setTimeout(function() {
            // íˆ´íŒ ë‚´ì˜ ëª¨ë“  ë¹„ë””ì˜¤ ì¬ìƒ ë©ˆì¶”ê¸°
            tooltip.find('video').each(function() {
                this.pause();
                this.currentTime = 0;
            });
            
            //tooltip_loading.css('display', 'none');
            tooltip.css('display', 'none');
        }, 200); // 0.2ì´ˆ ë”œë ˆì´
    }

    // íˆ´íŒ ìœ„ì¹˜ ì¡°ì • í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
    function adjustTooltipPosition(e) {
        // í™”ë©´ ê²½ê³„ ì²´í¬ (ì‹¤ì œ ë†’ì´ë¡œ ì •í™•í•œ ê³„ì‚°)
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        var scrollTop = $(window).scrollTop();
        var tooltipWidth = tooltip.outerWidth();
        var tooltipHeight = tooltip.outerHeight(); // ì´ì œ ì •í™•í•œ ë†’ì´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŒ
        
        var left = e.pageX + 10;
        var top = e.pageY + 10;
        
        // ì˜¤ë¥¸ìª½ ê²½ê³„ ì²´í¬
        if (left + tooltipWidth > windowWidth) {
            left = e.pageX - tooltipWidth - 10;
        }
        
        // í•˜ë‹¨ ê²½ê³„ ì²´í¬ (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê³ ë ¤)
        if (top + tooltipHeight > windowHeight + scrollTop) {
            top = e.pageY - tooltipHeight - 10;
            // ìœ„ìª½ìœ¼ë¡œë„ ë²—ì–´ë‚˜ëŠ” ê²½ìš° ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì—ì„œ ì ì ˆíˆ ì¡°ì •
            if (top < scrollTop) {
                top = scrollTop + 10;
            }
        }
        
        // ìµœì¢… ìœ„ì¹˜ ì ìš© ë° í‘œì‹œ
        tooltip.css({
            'left': left + 'px',
            'top': top + 'px',
            'visibility': 'visible'
        });
    }

    function setupTooltip() {
        // ê³µí†µ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ í•˜ë‚˜ì˜ í•¨ìˆ˜ë¡œ ì •ì˜
        function attachTooltipEvents(selector) {
            $(selector).each(function(index, element) {
                var $element = $(element); // jQuery ê°ì²´ë¡œ ë˜í•‘
                
                // selector ì•ˆì— subject ê°€ ìˆê³  ê·¸ ì•ˆì— a ê°€ ìˆëŠ”ê²½ìš° selector ë¥¼ ê·¸ a ë¡œ ë³€ê²½
                if( $element.find('.subject a').length > 0 ) {
                    $element = $element.find('.subject a');
                }

                $element.on('mouseenter', function(e) {
                    var issueId = null;
                    
                    // id ì†ì„±ì—ì„œ issue-xxx íŒ¨í„´ ê²€ì¶œ
                    /*
                    var elementId = $(this).attr('id');
                    if (elementId && elementId.startsWith('issue-')) {
                        issueId = elementId.replace('issue-', '');
                    }
                    */

                    // href ì†ì„±ì—ì„œ /issues/xxx íŒ¨í„´ ê²€ì¶œ
                    if( issueId == null && $(this).attr('href') ) {
                      var href = $(this).attr('href');
                      var match = href.match(/^\/issues\/(\d+)$/);
                      if( match ) {
                        issueId = match[1];
                      }
                    }

                    // data-id ì†ì„±ì—ì„œ xxx íŒ¨í„´ ê²€ì¶œ
                    if( issueId == null && $(this).attr('data-id') ) {
                      issueId = $(this).attr('data-id');
                    }

                    // data-issue-tooltip ì†ì„±ì—ì„œ xxx íŒ¨í„´ ê²€ì¶œ
                    if( issueId == null && $(this).attr('data-issue-tooltip') ) {
                      issueId = $(this).attr('data-issue-tooltip');
                    }
                    
                    // idì—ì„œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ class ì†ì„±ì—ì„œ issue-xxx íŒ¨í„´ ê²€ì¶œ
                    if (!issueId) {
                        var elementClass = $(this).attr('class');
                        if (elementClass) {
                            var match = elementClass.match(/issue-(\d+)/);
                            if (match) {
                                issueId = match[1];
                            }
                        }
                    }
                    
                    if (issueId && /^\d+$/.test(issueId)) {
                        showTooltip(e, issueId);
                    }
                }).on('mouseleave', function() {
                    hideTooltip();
                }).on('mousemove', function(e) {
                  /*
                    if (tooltip.css('display') === 'block') {
                        tooltip.css({
                            'left': e.pageX + 10 + 'px',
                            'top': e.pageY + 10 + 'px'
                        });
                    }
                    */
                });
            }); // .each() ë‹«ëŠ” ê´„í˜¸ ì¶”ê°€
        }

        // ê° ì„ íƒìì— ë™ì¼í•œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì ìš©
        attachTooltipEvents('.hascontextmenu');
        
        // ìŠ¤ì¼€ì¥´ë°” ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ì—ë„ íˆ´íŒ ì ìš©
        attachTooltipEvents('[data-issue-tooltip]');
        
        // ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” ì´ìŠˆ ë§í¬ ì•„ì´ì½˜ì„ ìœ„í•œ ì´ë²¤íŠ¸ ìœ„ì„
        $(document).on('mouseenter', '[data-issue-tooltip]', function(e) {
            var issueId = $(this).attr('data-issue-tooltip');
            if (issueId && /^\d+$/.test(issueId)) {
                showTooltip(e, issueId);
            }
        }).on('mouseleave', '[data-issue-tooltip]', function() {
            hideTooltip();
        });
    }

    // í˜ì´ì§€ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ íˆ´íŒ ì„¤ì • ì‹¤í–‰
    $(document).ready(function() {
        setupTooltip();
    });

</script>

